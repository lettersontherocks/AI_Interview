<!-- æ²‰æµ¸å¼é¢è¯•æ¨¡å¼ -->
<view class="immersive-container {{isPlaying ? 'speaking' : ''}}">
  <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
  <view class="top-bar">
    <view class="back-btn" bindtap="onBack">
      <text class="back-icon">â†</text>
    </view>
    <view class="progress-info">
      <view class="progress-bar-mini">
        <view class="progress-fill-mini" style="width: {{progress}}%"></view>
      </view>
      <text class="progress-label">ç¬¬ {{currentQuestion}} é¢˜ Â· {{progress}}%</text>
    </view>
    <view class="mode-switch" bindtap="switchToChatMode">
      <text class="switch-icon">ğŸ’¬</text>
    </view>
  </view>

  <!-- ä¾§è¾¹æ§åˆ¶é¢æ¿ -->
  <view class="side-controls" wx:if="{{currentQuestionText && !loading}}">
    <view class="side-control-item" bindtap="toggleAudio">
      <text class="side-control-icon">{{isPlaying ? 'â¸' : (hasEnded ? 'ğŸ”' : 'â–¶ï¸')}}</text>
    </view>
    <view class="side-control-item" bindtap="toggleAutoPlay">
      <text class="side-control-icon">{{autoPlayEnabled ? 'ğŸ”Š' : 'ğŸ”‡'}}</text>
    </view>
    <view class="side-control-item" bindtap="showHistoryDrawer">
      <text class="side-control-icon">ğŸ“‹</text>
    </view>
    <view class="side-control-item" bindtap="toggleQuestionText">
      <text class="side-control-icon">{{showQuestionText ? 'ğŸ‘' : 'ğŸ“'}}</text>
    </view>
  </view>

  <!-- é¢è¯•å®˜åŒºåŸŸ -->
  <view class="interviewer-section">
    <!-- å¤´åƒ -->
    <view class="avatar-container {{isPlaying ? 'pulsing' : ''}} {{loading ? 'thinking' : ''}}">
      <view class="avatar-outer-ring"></view>
      <view class="avatar-middle-ring"></view>
      <view class="avatar">
        <text class="avatar-icon">ğŸ‘”</text>
      </view>
      <!-- å£°æ³¢åŠ¨ç”» -->
      <view wx:if="{{isPlaying}}" class="sound-waves">
        <view class="wave wave-1"></view>
        <view class="wave wave-2"></view>
        <view class="wave wave-3"></view>
      </view>
    </view>

    <!-- æ€è€ƒåŠ¨ç”»ï¼ˆç§»åˆ°å¤´åƒä¸‹æ–¹ï¼‰ -->
    <view wx:if="{{loading}}" class="thinking-dots">
      <view class="dot dot-1"></view>
      <view class="dot dot-2"></view>
      <view class="dot dot-3"></view>
    </view>

    <!-- çŠ¶æ€æç¤º -->
    <view class="status-text {{questionFadeOut ? 'fade-out' : ''}} {{questionVisible ? 'fade-in' : ''}}">
      <text wx:if="{{loading}}">ğŸ¤” é¢è¯•å®˜æ­£åœ¨æ€è€ƒ...</text>
      <text wx:elif="{{isPlaying}}">ğŸ”Š é¢è¯•å®˜æé—®ä¸­...</text>
      <text wx:elif="{{!currentQuestion || currentQuestion === 0}}">å‡†å¤‡å¼€å§‹é¢è¯•</text>
      <text wx:else>ğŸ’­ ç­‰å¾…æ‚¨çš„å›ç­”</text>
    </view>

    <!-- é—®é¢˜æ–‡å­—ï¼ˆæ¡ä»¶æ˜¾ç¤ºï¼‰ -->
    <scroll-view class="question-text {{questionFadeOut ? 'fade-out' : ''}} {{questionVisible ? 'fade-in' : ''}}" scroll-y wx:if="{{showQuestionText && !loading && questionVisible}}">
      <text class="question-content">{{currentQuestionText}}</text>
    </scroll-view>
  </view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-section" wx:if="{{!finished && !loading}}">
    <!-- è¾“å…¥æ¡† -->
    <view class="input-wrapper">
      <!-- è¯­éŸ³æ¨¡å¼åˆ‡æ¢ -->
      <view class="voice-toggle" bindtap="toggleInputMode">
        <text class="voice-icon">{{inputMode === 'text' ? 'ğŸ¤' : 'âŒ¨ï¸'}}</text>
      </view>

      <!-- æ–‡å­—è¾“å…¥ -->
      <view wx:if="{{inputMode === 'text'}}" class="text-input-box">
        <textarea
          class="answer-textarea"
          placeholder="è¾“å…¥æ‚¨çš„å›ç­”..."
          value="{{currentAnswer}}"
          bindinput="onInput"
          auto-height
          maxlength="1000"
        />
        <view
          class="send-button {{canSend ? 'active' : ''}}"
          bindtap="submitAnswer"
        >
          <text class="send-icon">â¤</text>
        </view>
      </view>

      <!-- è¯­éŸ³è¾“å…¥ -->
      <view wx:else class="voice-input-box">
        <view class="record-status" wx:if="{{isRecording}}">
          <view class="recording-indicator">
            <view class="recording-dot"></view>
            <text>å½•éŸ³ä¸­ {{recordDuration}}s</text>
          </view>
        </view>
        <button
          class="record-button {{isRecording ? 'recording' : ''}}"
          bindtap="toggleRecord"
        >
          {{isRecording ? 'ç‚¹å‡»ç»“æŸ' : 'ç‚¹å‡»å½•éŸ³'}}
        </button>
      </view>
    </view>
  </view>

  <!-- å®ŒæˆçŠ¶æ€ -->
  <view class="finish-overlay" wx:if="{{finished}}">
    <view class="finish-content">
      <view class="finish-icon">âœ…</view>
      <view class="finish-title">é¢è¯•å®Œæˆï¼</view>
      <view class="finish-desc">æ­£åœ¨ç”Ÿæˆæ‚¨çš„é¢è¯•æŠ¥å‘Š...</view>
      <button class="view-report-button" bindtap="viewReport">
        æŸ¥çœ‹æŠ¥å‘Š
      </button>
    </view>
  </view>

  <!-- å†å²å¯¹è¯æŠ½å±‰ -->
  <view class="history-drawer {{showHistory ? 'show' : ''}}" catchtap="hideHistory">
    <view class="drawer-content" catchtap="stopPropagation">
      <view class="drawer-header">
        <text class="drawer-title">å¯¹è¯å†å²</text>
        <text class="drawer-close" bindtap="hideHistory">Ã—</text>
      </view>
      <scroll-view class="drawer-body" scroll-y>
        <view
          class="history-item {{item.role}}"
          wx:for="{{messages}}"
          wx:key="index"
        >
          <view class="history-avatar">
            <text>{{item.role === 'interviewer' ? 'ğŸ‘”' : 'ğŸ‘¤'}}</text>
          </view>
          <view class="history-content">
            <text>{{item.content}}</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>
