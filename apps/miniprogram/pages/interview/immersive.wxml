<!-- æ²‰æµ¸å¼é¢è¯•æ¨¡å¼ -->
<view class="immersive-container {{isPlaying ? 'speaking' : ''}}">
  <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
  <view class="top-bar">
    <view class="back-btn" bindtap="onBack">
      <text class="back-icon">â†</text>
    </view>
    <view class="progress-info">
      <view class="progress-bar-mini">
        <view class="progress-fill-mini" style="width: {{progress}}%"></view>
      </view>
      <text class="progress-label">ç¬¬ {{currentQuestion}} é¢˜ Â· {{progress}}%</text>
    </view>
    <view class="mode-switch" bindtap="switchToChatMode">
      <text class="switch-icon">ğŸ’¬</text>
    </view>
  </view>

  <!-- é¢è¯•å®˜åŒºåŸŸ -->
  <view class="interviewer-section">
    <!-- å¤´åƒ -->
    <view class="avatar-container {{isPlaying ? 'pulsing' : ''}}">
      <view class="avatar-outer-ring"></view>
      <view class="avatar-middle-ring"></view>
      <view class="avatar">
        <text class="avatar-icon">ğŸ‘”</text>
      </view>
      <!-- å£°æ³¢åŠ¨ç”» -->
      <view wx:if="{{isPlaying}}" class="sound-waves">
        <view class="wave wave-1"></view>
        <view class="wave wave-2"></view>
        <view class="wave wave-3"></view>
      </view>
    </view>

    <!-- çŠ¶æ€æç¤º -->
    <view class="status-text">
      <text wx:if="{{loading}}">ğŸ¤” é¢è¯•å®˜æ­£åœ¨æ€è€ƒ...</text>
      <text wx:elif="{{isPlaying}}">ğŸ”Š é¢è¯•å®˜æé—®ä¸­...</text>
      <text wx:elif="{{!currentQuestion || currentQuestion === 0}}">å‡†å¤‡å¼€å§‹é¢è¯•</text>
      <text wx:else>ğŸ’­ ç­‰å¾…æ‚¨çš„å›ç­”</text>
    </view>

    <!-- é—®é¢˜æ–‡å­— -->
    <scroll-view class="question-text" scroll-y>
      <text class="question-content">{{currentQuestionText}}</text>
    </scroll-view>

    <!-- æ’­æ”¾æ§åˆ¶ -->
    <view class="audio-controls" wx:if="{{currentQuestionText && !loading}}">
      <view class="control-btn" bindtap="toggleAudio">
        <text class="control-icon">{{isPlaying ? 'â¸' : (hasPlayed ? 'ğŸ”' : 'â–¶ï¸')}}</text>
        <text class="control-label">{{isPlaying ? 'æš‚åœ' : (hasPlayed ? 'é‡å¬' : 'æ’­æ”¾')}}</text>
      </view>
      <view class="control-btn" bindtap="toggleAutoPlay">
        <text class="control-icon">{{autoPlayEnabled ? 'ğŸ”Š' : 'ğŸ”‡'}}</text>
        <text class="control-label">{{autoPlayEnabled ? 'è‡ªåŠ¨æ’­æ”¾' : 'æ‰‹åŠ¨æ’­æ”¾'}}</text>
      </view>
    </view>
  </view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-section" wx:if="{{!finished && !loading}}">
    <!-- å¿«æ·æ“ä½œ -->
    <view class="quick-actions">
      <view class="quick-btn" bindtap="showHistory">
        <text>ğŸ“‹ æŸ¥çœ‹å†å²</text>
      </view>
      <view class="quick-btn" bindtap="requestHint">
        <text>ğŸ’¡ å¬ä¸æ¸…ï¼Ÿ</text>
      </view>
    </view>

    <!-- è¾“å…¥æ¡† -->
    <view class="input-wrapper">
      <!-- è¯­éŸ³æ¨¡å¼åˆ‡æ¢ -->
      <view class="voice-toggle" bindtap="toggleInputMode">
        <text class="voice-icon">{{inputMode === 'text' ? 'ğŸ¤' : 'âŒ¨ï¸'}}</text>
      </view>

      <!-- æ–‡å­—è¾“å…¥ -->
      <view wx:if="{{inputMode === 'text'}}" class="text-input-box">
        <textarea
          class="answer-textarea"
          placeholder="è¾“å…¥æ‚¨çš„å›ç­”..."
          value="{{currentAnswer}}"
          bindinput="onInput"
          auto-height
          maxlength="1000"
        />
        <view
          class="send-button {{canSend ? 'active' : ''}}"
          bindtap="submitAnswer"
        >
          <text>å‘é€</text>
        </view>
      </view>

      <!-- è¯­éŸ³è¾“å…¥ -->
      <view wx:else class="voice-input-box">
        <view class="record-status">
          <text wx:if="{{!isRecording}}">æŒ‰ä½è¯´è¯</text>
          <view wx:else class="recording-indicator">
            <view class="recording-dot"></view>
            <text>å½•éŸ³ä¸­ {{recordDuration}}s</text>
          </view>
        </view>
        <button
          class="record-button {{isRecording ? 'recording' : ''}}"
          bindtouchstart="startRecord"
          bindtouchend="stopRecord"
          bindtouchcancel="stopRecord"
        >
          {{isRecording ? 'æ¾å¼€å‘é€' : 'æŒ‰ä½è¯´è¯'}}
        </button>
      </view>
    </view>
  </view>

  <!-- å®ŒæˆçŠ¶æ€ -->
  <view class="finish-overlay" wx:if="{{finished}}">
    <view class="finish-content">
      <view class="finish-icon">âœ…</view>
      <view class="finish-title">é¢è¯•å®Œæˆï¼</view>
      <view class="finish-desc">æ­£åœ¨ç”Ÿæˆæ‚¨çš„é¢è¯•æŠ¥å‘Š...</view>
      <button class="view-report-button" bindtap="viewReport">
        æŸ¥çœ‹æŠ¥å‘Š
      </button>
    </view>
  </view>

  <!-- å†å²å¯¹è¯æŠ½å±‰ -->
  <view class="history-drawer {{showHistory ? 'show' : ''}}" catchtap="hideHistory">
    <view class="drawer-content" catchtap="stopPropagation">
      <view class="drawer-header">
        <text class="drawer-title">å¯¹è¯å†å²</text>
        <text class="drawer-close" bindtap="hideHistory">Ã—</text>
      </view>
      <scroll-view class="drawer-body" scroll-y>
        <view
          class="history-item {{item.role}}"
          wx:for="{{messages}}"
          wx:key="index"
        >
          <view class="history-avatar">
            <text>{{item.role === 'interviewer' ? 'ğŸ‘”' : 'ğŸ‘¤'}}</text>
          </view>
          <view class="history-content">
            <text>{{item.content}}</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>
