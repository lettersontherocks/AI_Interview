<!-- pages/index/index.wxml -->
<view class="container">
  <!-- é¡¶éƒ¨æ¬¢è¿åŒºåŸŸ -->
  <view class="welcome-section">
    <view class="welcome-title">AIé¢è¯•ç»ƒä¹ </view>
    <view class="welcome-subtitle">æ™ºèƒ½æ¨¡æ‹ŸçœŸå®é¢è¯•ï¼Œæå‡é¢è¯•æŠ€å·§</view>

    <view class="quota-info card">
      <view class="quota-text">
        <text wx:if="{{!userInfo}}">è¯·å…ˆç™»å½•</text>
        <text wx:elif="{{userInfo.is_vip}}">VIPä¼šå‘˜ Â· æ— é™æ¬¡</text>
        <text wx:else>ä»Šæ—¥å‰©ä½™: {{userInfo.free_count_today}}/2 æ¬¡</text>
      </view>
      <button wx:if="{{!userInfo}}" class="login-btn" bindtap="handleLogin">
        ç‚¹å‡»ç™»å½•
      </button>
    </view>
  </view>

  <!-- æ¨èè·¯å¾„å¡ç‰‡ -->
  <view class="recommend-card" wx:if="{{recommendedRound}}">
    <view class="recommend-header">
      <text class="recommend-icon">ğŸ¯</text>
      <view class="recommend-info">
        <text class="recommend-title">æ¨èç»ƒä¹ è·¯å¾„</text>
        <text class="recommend-subtitle">å¾ªåºæ¸è¿›ï¼Œç¨³æ­¥æå‡</text>
      </view>
    </view>
    <view class="recommend-content">
      <view class="progress-dots">
        <view class="dot {{item.completed ? 'completed' : ''}} {{item.current ? 'current' : ''}}"
              wx:for="{{roundProgress}}" wx:key="index">
          <text class="dot-label">{{item.label}}</text>
        </view>
      </view>
      <view class="recommend-action">
        <text class="next-round">ä¸‹ä¸€æ­¥ï¼š{{recommendedRound.label}}</text>
        <button class="quick-start-btn" bindtap="quickStartRecommended">
          å¿«é€Ÿå¼€å§‹
        </button>
      </view>
    </view>
  </view>

  <!-- å²—ä½é€‰æ‹© -->
  <view class="section">
    <view class="section-title">é€‰æ‹©é¢è¯•å²—ä½</view>

    <!-- æœç´¢æ¡† -->
    <view class="search-box">
      <input
        class="search-input"
        placeholder="æœç´¢å²—ä½ï¼Œå¦‚ï¼šJavaã€å‰ç«¯ã€äº§å“..."
        bindinput="onSearchInput"
        bindconfirm="onSearchConfirm"
        value="{{searchKeyword}}"
      />
      <view class="search-icon">ğŸ”</view>

      <!-- ä¸‹æ‹‰æœç´¢ç»“æœ -->
      <view wx:if="{{searchResults.length > 0}}" class="search-dropdown">
        <view
          class="dropdown-item {{selectedPositionId === item.id ? 'active' : ''}}"
          wx:for="{{searchResults}}"
          wx:key="id"
          bindtap="selectPositionFromSearch"
          data-id="{{item.id}}"
          data-name="{{item.name}}"
        >
          <view class="dropdown-name">{{item.name}}</view>
          <view class="dropdown-desc">{{item.description}}</view>
        </view>
      </view>
    </view>

    <!-- åˆ†ç±»åˆ—è¡¨ -->
    <view wx:elif="{{!searchKeyword}}" class="categories">
      <view
        class="category"
        wx:for="{{categories}}"
        wx:key="id"
      >
        <view class="category-header" bindtap="toggleCategory" data-index="{{index}}">
          <text class="category-icon">{{item.icon}}</text>
          <text class="category-name">{{item.name}}</text>
          <text class="expand-icon">{{item.expanded ? 'â–¼' : 'â–¶'}}</text>
        </view>

        <view wx:if="{{item.expanded}}" class="positions-list">
          <view
            class="position-item {{selectedPositionId === position.id ? 'active' : ''}}"
            wx:for="{{item.positions}}"
            wx:for-item="position"
            wx:key="id"
            bindtap="selectPosition"
            data-id="{{position.id}}"
            data-name="{{position.name}}"
            data-has-children="{{position.sub_positions && position.sub_positions.length > 0}}"
          >
            <view class="position-main">
              <text class="position-icon">{{position.icon}}</text>
              <view class="position-info">
                <text class="position-name">{{position.name}}</text>
                <text class="position-desc">{{position.description}}</text>
              </view>
              <text wx:if="{{position.sub_positions && position.sub_positions.length > 0}}" class="has-sub">â–¶</text>
            </view>

            <!-- å­å²—ä½ï¼ˆå¦‚æœæœ‰ï¼‰ -->
            <view wx:if="{{position.showSub && position.sub_positions}}" class="sub-positions">
              <view
                class="sub-position-item {{selectedPositionId === sub.id ? 'active' : ''}}"
                wx:for="{{position.sub_positions}}"
                wx:for-item="sub"
                wx:key="id"
                bindtap="selectSubPosition"
                data-id="{{sub.id}}"
                data-name="{{sub.name}}"
                data-parent-name="{{position.name}}"
              >
                <text class="sub-name">{{sub.name}}</text>
                <text class="sub-desc">{{sub.description}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å·²é€‰æ‹©æç¤º -->
    <view wx:if="{{selectedPositionName}}" class="selected-hint">
      å·²é€‰æ‹©ï¼š{{selectedPositionName}}
    </view>
  </view>

  <!-- é¢è¯•è½®æ¬¡é€‰æ‹© -->
  <view class="section">
    <view class="section-title">é€‰æ‹©é¢è¯•è½®æ¬¡</view>
    <view class="round-list">
      <view
        class="round-item {{selectedRound === item.value ? 'active' : ''}}"
        wx:for="{{rounds}}"
        wx:key="value"
        bindtap="selectRound"
        data-round="{{item.value}}"
      >
        <view class="round-name">{{item.label}}</view>
        <view class="round-desc">{{item.desc}}</view>
      </view>
    </view>
  </view>

  <!-- ç®€å†è¾“å…¥ï¼ˆå¯é€‰ï¼‰ -->
  <view class="section">
    <view class="section-title">
      ç®€å†ä¿¡æ¯
      <text class="optional">(å¯é€‰)</text>
    </view>
    <textarea
      class="resume-input"
      placeholder="ç®€å•ä»‹ç»ä½ çš„å·¥ä½œç»éªŒã€æŠ€æœ¯æ ˆç­‰ï¼ŒAIä¼šæ ¹æ®ç®€å†æé—®..."
      maxlength="500"
      bindinput="inputResume"
      value="{{resume}}"
    />
    <view class="char-count">{{resume.length}}/500</view>
  </view>

  <!-- å¼€å§‹æŒ‰é’® -->
  <view class="start-section">
    <button
      class="start-btn primary-btn"
      bindtap="startInterview"
      disabled="{{!selectedPositionId || !selectedRound}}"
    >
      å¼€å§‹é¢è¯•
    </button>
    <view class="hint-text">
      é¢„è®¡ç”¨æ—¶ 15-20 åˆ†é’Ÿ
    </view>
  </view>

  <!-- åŠ è½½é®ç½©å±‚ -->
  <view class="loading-overlay" wx:if="{{isPreparingInterview}}">
    <view class="loading-content">
      <view class="loading-icon">
        <view class="spinner">
          <view class="spinner-blade"></view>
          <view class="spinner-blade"></view>
          <view class="spinner-blade"></view>
          <view class="spinner-blade"></view>
          <view class="spinner-blade"></view>
          <view class="spinner-blade"></view>
          <view class="spinner-blade"></view>
          <view class="spinner-blade"></view>
        </view>
      </view>
      <view class="loading-text">æ­£åœ¨å‡†å¤‡æ‚¨çš„é¢è¯•</view>
      <view class="loading-subtitle">AIé¢è¯•å®˜æ­£åœ¨ä¸ºæ‚¨å®šåˆ¶é¢è¯•æ–¹æ¡ˆ...</view>
      <view class="loading-tips">
        <view class="tip-item" wx:for="{{loadingTips}}" wx:key="index">
          <text class="tip-dot">â€¢</text>
          <text class="tip-text">{{item}}</text>
        </view>
      </view>
    </view>
  </view>
</view>
