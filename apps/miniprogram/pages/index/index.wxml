<!-- pages/index/index.wxml -->
<wxs module="utils">
  var getStyleName = function(styleId, styles) {
    for (var i = 0; i < styles.length; i++) {
      if (styles[i].id === styleId) {
        return styles[i].name;
      }
    }
    return '';
  };

  module.exports = {
    getStyleName: getStyleName
  };
</wxs>

<view class="container">
  <!-- é¡¶éƒ¨æ¬¢è¿åŒºåŸŸ -->
  <view class="welcome-section">
    <view class="welcome-title">AIé¢è¯•ç»ƒä¹ </view>
    <view class="welcome-subtitle">æ™ºèƒ½æ¨¡æ‹ŸçœŸå®é¢è¯•ï¼Œæå‡é¢è¯•æŠ€å·§</view>

    <view class="quota-info card">
      <view class="quota-text">
        <text wx:if="{{!userInfo}}">è¯·å…ˆç™»å½•</text>
        <text wx:elif="{{userInfo.is_vip}}">VIPä¼šå‘˜ Â· æ— é™æ¬¡</text>
        <text wx:else>ä»Šæ—¥å‰©ä½™: {{userInfo.free_count_today}}/2 æ¬¡</text>
      </view>
      <button wx:if="{{!userInfo}}" class="login-btn" bindtap="handleLogin">
        ç‚¹å‡»ç™»å½•
      </button>
    </view>
  </view>

  <!-- æ¨èè·¯å¾„å¡ç‰‡ -->
  <view class="recommend-card" wx:if="{{recommendedRound}}">
    <view class="recommend-header">
      <text class="recommend-icon">ğŸ¯</text>
      <view class="recommend-info">
        <text class="recommend-title">æ¨èç»ƒä¹ è·¯å¾„</text>
        <text class="recommend-subtitle">å¾ªåºæ¸è¿›ï¼Œç¨³æ­¥æå‡</text>
      </view>
    </view>
    <view class="recommend-content">
      <view class="progress-dots">
        <view class="dot {{item.completed ? 'completed' : ''}} {{item.current ? 'current' : ''}}"
              wx:for="{{roundProgress}}" wx:key="index">
          <text class="dot-label">{{item.label}}</text>
        </view>
      </view>
      <view class="recommend-action">
        <text class="next-round">ä¸‹ä¸€æ­¥ï¼š{{recommendedRound.label}}</text>
        <button class="quick-start-btn" bindtap="quickStartRecommended">
          å¿«é€Ÿå¼€å§‹
        </button>
      </view>
    </view>
  </view>

  <!-- å²—ä½é€‰æ‹© -->
  <view class="section position-section">
    <view class="section-title">é€‰æ‹©é¢è¯•å²—ä½</view>

    <!-- å·²é€‰æ‹©æç¤ºæˆ–å±•å¼€æŒ‰é’® -->
    <view wx:if="{{selectedPositionName}}" class="selected-display" bindtap="togglePositionList">
      <view class="selected-content">
        <text class="selected-label">å·²é€‰æ‹©ï¼š{{selectedPositionName}}</text>
        <text class="change-btn">æ›´æ¢</text>
      </view>
    </view>

    <!-- å±•å¼€æŒ‰é’®ï¼ˆæœªé€‰æ‹©æ—¶ï¼‰ -->
    <view wx:else class="expand-trigger" bindtap="togglePositionList">
      <text class="expand-text">{{showPositionList ? 'æ”¶èµ·å²—ä½åˆ—è¡¨' : 'ç‚¹å‡»é€‰æ‹©å²—ä½'}}</text>
      <text class="expand-icon">{{showPositionList ? 'â–²' : 'â–¼'}}</text>
    </view>

    <!-- å¯å±•å¼€çš„å²—ä½é€‰æ‹©åŒºåŸŸï¼ˆæµ®å±‚è¦†ç›–æ¨¡å¼ï¼‰ -->
    <view wx:if="{{showPositionList}}" class="position-overlay" bindtap="togglePositionList">
      <view class="position-dropdown" catchtap="stopPropagation">
      <!-- æœç´¢æ¡† -->
      <view class="search-box">
        <input
          class="search-input"
          placeholder="æœç´¢å²—ä½ï¼Œå¦‚ï¼šJavaã€å‰ç«¯ã€äº§å“..."
          bindinput="onSearchInput"
          bindconfirm="onSearchConfirm"
          value="{{searchKeyword}}"
        />
        <view class="search-icon">ğŸ”</view>

        <!-- ä¸‹æ‹‰æœç´¢ç»“æœ -->
        <view wx:if="{{searchResults.length > 0}}" class="search-dropdown">
          <view
            class="dropdown-item {{selectedPositionId === item.id ? 'active' : ''}}"
            wx:for="{{searchResults}}"
            wx:key="id"
            bindtap="selectPositionFromSearch"
            data-id="{{item.id}}"
            data-name="{{item.name}}"
          >
            <view class="dropdown-name">{{item.name}}</view>
            <view class="dropdown-desc">{{item.description}}</view>
          </view>
        </view>
      </view>

      <!-- åˆ†ç±»åˆ—è¡¨ -->
      <view wx:if="{{!searchKeyword}}" class="categories">
      <view
        class="category"
        wx:for="{{categories}}"
        wx:key="id"
      >
        <view class="category-header" bindtap="toggleCategory" data-index="{{index}}">
          <text class="category-icon">{{item.icon}}</text>
          <text class="category-name">{{item.name}}</text>
          <text class="expand-icon">{{item.expanded ? 'â–¼' : 'â–¶'}}</text>
        </view>

        <view wx:if="{{item.expanded}}" class="positions-list">
          <view
            class="position-item {{selectedPositionId === position.id ? 'active' : ''}}"
            wx:for="{{item.positions}}"
            wx:for-item="position"
            wx:key="id"
            bindtap="selectPosition"
            data-id="{{position.id}}"
            data-name="{{position.name}}"
            data-has-children="{{position.sub_positions && position.sub_positions.length > 0}}"
          >
            <view class="position-main">
              <text class="position-icon">{{position.icon}}</text>
              <view class="position-info">
                <text class="position-name">{{position.name}}</text>
                <text class="position-desc">{{position.description}}</text>
              </view>
              <text wx:if="{{position.sub_positions && position.sub_positions.length > 0}}" class="has-sub">â–¶</text>
            </view>

            <!-- å­å²—ä½ï¼ˆå¦‚æœæœ‰ï¼‰ -->
            <view wx:if="{{position.showSub && position.sub_positions}}" class="sub-positions">
              <view
                class="sub-position-item {{selectedPositionId === sub.id ? 'active' : ''}}"
                wx:for="{{position.sub_positions}}"
                wx:for-item="sub"
                wx:key="id"
                bindtap="selectSubPosition"
                data-id="{{sub.id}}"
                data-name="{{sub.name}}"
                data-parent-name="{{position.name}}"
              >
                <text class="sub-name">{{sub.name}}</text>
                <text class="sub-desc">{{sub.description}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
      </view>
    </view>
  </view>

  <!-- é¢è¯•è½®æ¬¡é€‰æ‹© -->
  <view class="section">
    <view class="section-title">é€‰æ‹©é¢è¯•è½®æ¬¡</view>
    <view class="round-list">
      <view
        class="round-item {{selectedRound === item.value ? 'active' : ''}}"
        wx:for="{{rounds}}"
        wx:key="value"
        bindtap="selectRound"
        data-round="{{item.value}}"
      >
        <view class="round-name">{{item.label}}</view>
        <view class="round-desc">{{item.desc}}</view>
      </view>
    </view>
  </view>

  <!-- é¢è¯•å®˜é£æ ¼é€‰æ‹© -->
  <view class="section style-section">
    <view class="section-title">
      é€‰æ‹©é¢è¯•å®˜é£æ ¼
      <text class="optional">(å¯é€‰ï¼Œä¸é€‰åˆ™è‡ªåŠ¨æ¨è)</text>
    </view>

    <!-- å·²é€‰æ‹©æç¤ºæˆ–é»˜è®¤æ¨è -->
    <view wx:if="{{selectedInterviewerStyle}}" class="selected-display" bindtap="toggleStyleList">
      <view class="selected-content">
        <text class="selected-label">å·²é€‰æ‹©ï¼š{{utils.getStyleName(selectedInterviewerStyle, interviewerStyles)}}</text>
        <text class="change-btn">æ›´æ¢</text>
      </view>
    </view>

    <!-- å±•å¼€æŒ‰é’®ï¼ˆæœªé€‰æ‹©æ—¶æ˜¾ç¤ºæ¨èæˆ–æç¤ºï¼‰ -->
    <view wx:else class="expand-trigger {{!selectedRound ? 'expand-trigger-disabled' : ''}}" bindtap="toggleStyleList">
      <text class="expand-text">{{showStyleList ? 'æ”¶èµ·é£æ ¼åˆ—è¡¨' : (selectedRound ? 'ç‚¹å‡»é€‰æ‹©é£æ ¼' : 'è¯·å…ˆé€‰æ‹©é¢è¯•è½®æ¬¡')}}</text>
      <text class="expand-icon" wx:if="{{selectedRound}}">{{showStyleList ? 'â–²' : 'â–¼'}}</text>
      <text class="lock-icon" wx:else>ğŸ”’</text>
    </view>

    <!-- å¯å±•å¼€çš„é£æ ¼é€‰æ‹©åŒºåŸŸï¼ˆæµ®å±‚è¦†ç›–æ¨¡å¼ï¼‰ -->
    <view wx:if="{{showStyleList}}" class="style-overlay" bindtap="toggleStyleList">
      <view class="style-dropdown" catchtap="stopPropagation">
      <view class="style-list">
        <view
          class="style-item {{selectedInterviewerStyle === item.id ? 'active' : ''}} {{recommendedStyle === item.id && !selectedInterviewerStyle ? 'recommended' : ''}}"
          wx:for="{{interviewerStyles}}"
          wx:key="id"
          bindtap="selectInterviewerStyle"
          data-style="{{item.id}}"
        >
          <view class="style-icon">{{item.icon}}</view>
          <view class="style-info">
            <view class="style-name">
              {{item.name}}
              <text wx:if="{{recommendedStyle === item.id}}" class="recommend-badge">æ¨è</text>
            </view>
            <view class="style-desc">{{item.description}}</view>
          </view>
        </view>
      </view>
      </view>
    </view>
  </view>

  <!-- ç®€å†ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰ - ç´§å‡‘æ¨¡å¼ -->
  <view class="section resume-section-compact">
    <view class="section-title-inline">
      ç®€å†ä¿¡æ¯<text class="optional">(å¯é€‰)</text>
    </view>

    <!-- å•è¡ŒæŒ‰é’® -->
    <view class="resume-actions">
      <button class="resume-btn-compact" bindtap="handleManualInput">
        ğŸ“ {{resume ? 'å·²è¾“å…¥' : 'è¾“å…¥ç®€å†'}}
      </button>
      <button class="resume-btn-compact secondary" bindtap="handleUploadFile">
        ğŸ“„ ä¸Šä¼ æ–‡ä»¶
      </button>
    </view>
  </view>

  <!-- å¼€å§‹æŒ‰é’® -->
  <view class="start-section">
    <button
      class="start-btn primary-btn"
      bindtap="startInterview"
      disabled="{{!selectedPositionId || !selectedRound}}"
    >
      å¼€å§‹é¢è¯•
    </button>
    <view class="hint-text">
      é¢„è®¡ç”¨æ—¶ 15-20 åˆ†é’Ÿ
    </view>
  </view>

  <!-- åŠ è½½é®ç½©å±‚ -->
  <view class="loading-overlay" wx:if="{{isPreparingInterview}}">
    <view class="loading-content">
      <view class="loading-icon">
        <view class="spinner">
          <view class="spinner-blade"></view>
          <view class="spinner-blade"></view>
          <view class="spinner-blade"></view>
          <view class="spinner-blade"></view>
          <view class="spinner-blade"></view>
          <view class="spinner-blade"></view>
          <view class="spinner-blade"></view>
          <view class="spinner-blade"></view>
        </view>
      </view>
      <view class="loading-text">æ­£åœ¨å‡†å¤‡æ‚¨çš„é¢è¯•</view>
      <view class="loading-subtitle">AIé¢è¯•å®˜æ­£åœ¨ä¸ºæ‚¨å®šåˆ¶é¢è¯•æ–¹æ¡ˆ...</view>
      <view class="loading-tips">
        <view class="tip-item" wx:for="{{loadingTips}}" wx:key="index">
          <text class="tip-dot">â€¢</text>
          <text class="tip-text">{{item}}</text>
        </view>
      </view>
    </view>
  </view>
</view>
